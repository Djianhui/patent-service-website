# 状态管理

<cite>
**本文档引用的文件**
- [auth.ts](file://src/stores/auth.ts)
- [patentSearch.ts](file://src/stores/patentSearch.ts)
- [techReport.ts](file://src/stores/techReport.ts)
- [auth.ts](file://src/services/auth.ts)
- [patentSearch.ts](file://src/services/patentSearch.ts)
- [techReport.ts](file://src/services/techReport.ts)
- [index.ts](file://src/types/index.ts)
- [index.ts](file://src/utils/index.ts)
- [LoginView.vue](file://src/views/auth/LoginView.vue)
- [SearchResultsView.vue](file://src/views/patent-search/SearchResultsView.vue)
- [TechReportNewView.vue](file://src/views/tech-report/TechReportNewView.vue)
</cite>

## 目录
1. [项目结构](#项目结构)
2. [核心状态管理模块](#核心状态管理模块)
3. [用户认证状态管理](#用户认证状态管理)
4. [专利检索状态管理](#专利检索状态管理)
5. [技术报告状态管理](#技术报告状态管理)
6. [模块化组织与职责划分](#模块化组织与职责划分)
7. [组件中使用Store](#组件中使用store)
8. [状态持久化与错误处理](#状态持久化与错误处理)
9. [测试策略](#测试策略)

## 项目结构

项目采用模块化的状态管理架构，所有Pinia store集中存放在`src/stores`目录下，每个业务模块拥有独立的store文件。这种组织方式实现了关注点分离，便于维护和扩展。

```mermaid
graph TB
subgraph "src/stores"
auth[auth.ts]
patentSearch[patentSearch.ts]
techReport[techReport.ts]
counter[counter.ts]
end
subgraph "src/services"
authService[auth.ts]
patentSearchService[patentSearch.ts]
techReportService[techReport.ts]
end
subgraph "src/views"
loginView[LoginView.vue]
searchResultsView[SearchResultsView.vue]
techReportNewView[TechReportNewView.vue]
end
auth --> authService
patentSearch --> patentSearchService
techReport --> techReportService
loginView --> auth
searchResultsView --> patentSearch
techReportNewView --> techReport
style auth fill:#4CAF50,stroke:#388E3C
style patentSearch fill:#2196F3,stroke:#1976D2
style techReport fill:#FF9800,stroke:#F57C00
```

**图示来源**
- [auth.ts](file://src/stores/auth.ts)
- [patentSearch.ts](file://src/stores/patentSearch.ts)
- [techReport.ts](file://src/stores/techReport.ts)

**本节来源**
- [auth.ts](file://src/stores/auth.ts)
- [patentSearch.ts](file://src/stores/patentSearch.ts)
- [techReport.ts](file://src/stores/techReport.ts)

## 核心状态管理模块

项目采用Pinia作为状态管理解决方案，实现了三个核心业务模块的独立状态管理：用户认证、专利检索和技术报告。每个store都遵循Vue 3的Composition API模式，使用`defineStore`函数创建，通过`ref`定义状态，`computed`定义计算属性，以及`async`函数定义异步操作。

```mermaid
classDiagram
class Store {
<<abstract>>
+state : Ref
+getters : ComputedRef
+actions : Function
}
class AuthStore {
+token : string | null
+user : User | null
+loading : boolean
+isLoggedIn : boolean
+userRole : string
+userName : string
+login(credentials)
+logout()
+checkAuth()
+init()
}
class PatentSearchStore {
+searchResults : Patent[]
+currentPatent : Patent | null
+favoritePatents : Patent[]
+loading : boolean
+searching : boolean
+total : number
+quickSearch(keyword)
+advancedSearch(criteria)
+getPatentDetail(id)
+favoritePatent(id)
+unfavoritePatent(id)
}
class TechReportStore {
+reports : TechReport[]
+currentReport : TechReport | null
+loading : boolean
+generating : boolean
+total : number
+generateReport(data)
+getReportList(params)
+getReportDetail(id)
+deleteReport(id)
+exportReport(id, format)
}
Store <|-- AuthStore
Store <|-- PatentSearchStore
Store <|-- TechReportStore
```

**图示来源**
- [auth.ts](file://src/stores/auth.ts)
- [patentSearch.ts](file://src/stores/patentSearch.ts)
- [techReport.ts](file://src/stores/techReport.ts)

**本节来源**
- [auth.ts](file://src/stores/auth.ts)
- [patentSearch.ts](file://src/stores/patentSearch.ts)
- [techReport.ts](file://src/stores/techReport.ts)

## 用户认证状态管理

用户认证状态管理模块（`auth.ts`）负责处理用户登录、登出、权限验证等核心认证功能。该模块通过`useAuthStore`定义，实现了完整的用户会话管理生命周期。

### 状态与计算属性

认证状态模块维护了三个核心状态：`token`、`user`和`loading`。其中`token`和`user`从本地存储中初始化，确保页面刷新后用户状态的持久化。

```mermaid
classDiagram
class AuthState {
+token : string | null
+user : User | null
+loading : boolean
}
class AuthGetters {
+isLoggedIn : boolean
+userRole : string
+userName : string
}
AuthState --> AuthGetters : "衍生"
```

**图示来源**
- [auth.ts](file://src/stores/auth.ts)

### 认证操作流程

登录操作是认证模块的核心功能，通过`login` action实现。该操作不仅处理用户凭证验证，还负责SSE（Server-Sent Events）连接的建立，确保用户能够实时接收系统通知。

```mermaid
sequenceDiagram
participant LoginView as "登录界面"
participant AuthStore as "认证Store"
participant AuthService as "认证服务"
participant NotificationService as "通知服务"
LoginView->>AuthStore : 调用login(credentials)
AuthStore->>AuthService : 调用login API
AuthService->>Backend : 发送登录请求
Backend-->>AuthService : 返回token和用户信息
AuthService-->>AuthStore : 返回登录响应
AuthStore->>AuthStore : 保存token和用户信息到state
AuthStore->>AuthStore : 持久化存储到localStorage
AuthStore->>AuthService : 调用getUserInfo
AuthService->>Backend : 获取用户详细信息
Backend-->>AuthService : 返回用户详情
AuthService-->>AuthStore : 返回用户信息
AuthStore->>NotificationService : 建立SSE连接
NotificationService-->>AuthStore : 连接成功
AuthStore-->>LoginView : 登录成功
```

**图示来源**
- [auth.ts](file://src/stores/auth.ts)
- [auth.ts](file://src/services/auth.ts)
- [LoginView.vue](file://src/views/auth/LoginView.vue)

### 登出与会话清理

登出操作不仅清除认证状态，还负责清理相关资源，包括断开SSE连接和清除本地存储的认证信息。

```mermaid
flowchart TD
Start([登出开始]) --> DisconnectSSE["断开SSE连接"]
DisconnectSSE --> ClearState["清除Store状态"]
ClearState --> RemoveStorage["清除localStorage数据"]
RemoveStorage --> End([登出完成])
```

**图示来源**
- [auth.ts](file://src/stores/auth.ts)

**本节来源**
- [auth.ts](file://src/stores/auth.ts)
- [auth.ts](file://src/services/auth.ts)
- [LoginView.vue](file://src/views/auth/LoginView.vue)

## 专利检索状态管理

专利检索状态管理模块（`patentSearch.ts`）封装了专利检索领域的所有状态和逻辑，实现了从快速检索到收藏管理的完整功能链。

### 状态结构

该模块维护了多个状态变量，包括检索结果、当前专利、收藏专利列表、搜索历史等，为专利检索功能提供了全面的状态支持。

```mermaid
classDiagram
class PatentSearchState {
+searchResults : Patent[]
+currentPatent : Patent | null
+favoritePatents : Patent[]
+searchHistory : any[]
+loading : boolean
+searching : boolean
+total : number
+currentPage : number
+pageSize : number
+lastSearchCriteria : PatentSearchCriteria | null
}
class PatentSearchGetters {
+hasResults : boolean
+resultCount : number
+favoriteCount : number
+isSearching : boolean
}
PatentSearchState --> PatentSearchGetters : "衍生"
```

**图示来源**
- [patentSearch.ts](file://src/stores/patentSearch.ts)

### 检索与收藏流程

专利检索和收藏功能通过一系列action实现，形成了完整的用户操作流程。

```mermaid
sequenceDiagram
participant SearchView as "检索界面"
participant PatentSearchStore as "专利检索Store"
participant PatentSearchService as "专利检索服务"
SearchView->>PatentSearchStore : 调用quickSearch(keyword)
PatentSearchStore->>PatentSearchService : 调用quickSearch API
PatentSearchService->>Backend : 提交检索请求
Backend-->>PatentSearchService : 返回检索响应
PatentSearchService-->>PatentSearchStore : 返回空结果异步生成
PatentSearchStore->>SearchView : 检索提交成功
SearchView->>PatentSearchStore : 调用getSearchHistory()
PatentSearchStore->>PatentSearchService : 调用getSearchHistory API
PatentSearchService->>Backend : 获取检索历史
Backend-->>PatentSearchService : 返回历史记录
PatentSearchService-->>PatentSearchStore : 转换为Patent数组
PatentSearchStore->>SearchView : 返回检索历史
SearchView->>PatentSearchStore : 调用favoritePatent(id)
PatentSearchStore->>PatentSearchService : 调用favoritePatent API
PatentSearchService->>Backend : 收藏专利
Backend-->>PatentSearchService : 返回收藏结果
PatentSearchService-->>PatentSearchStore : 收藏成功
PatentSearchStore->>PatentSearchStore : 更新本地收藏列表
PatentSearchStore-->>SearchView : 收藏成功
```

**图示来源**
- [patentSearch.ts](file://src/stores/patentSearch.ts)
- [patentSearch.ts](file://src/services/patentSearch.ts)
- [SearchResultsView.vue](file://src/views/patent-search/SearchResultsView.vue)

**本节来源**
- [patentSearch.ts](file://src/stores/patentSearch.ts)
- [patentSearch.ts](file://src/services/patentSearch.ts)
- [SearchResultsView.vue](file://src/views/patent-search/SearchResultsView.vue)

## 技术报告状态管理

技术报告状态管理模块（`techReport.ts`）负责技术方案报告的生成、管理和导出，为用户提供专业的技术分析服务。

### 状态与功能

该模块维护了报告列表、当前报告、生成状态等核心状态，支持报告的全生命周期管理。

```mermaid
classDiagram
class TechReportState {
+reports : TechReport[]
+currentReport : TechReport | null
+loading : boolean
+generating : boolean
+total : number
+currentPage : number
+pageSize : number
}
class TechReportGetters {
+reportList : TechReport[]
+isGenerating : boolean
+reportCount : number
+completedReports : TechReport[]
}
TechReportState --> TechReportGetters : "衍生"
```

**图示来源**
- [techReport.ts](file://src/stores/techReport.ts)

### 报告生成流程

报告生成是技术报告模块的核心功能，通过`generateReport` action实现，支持异步生成和进度反馈。

```mermaid
sequenceDiagram
participant ReportView as "报告界面"
participant TechReportStore as "技术报告Store"
participant TechReportService as "技术报告服务"
ReportView->>TechReportStore : 调用generateReport(data)
TechReportStore->>TechReportService : 调用generateReport API
TechReportService->>Backend : 提交报告生成请求
Backend-->>TechReportService : 返回提交结果
TechReportService-->>TechReportStore : 返回提交成功
TechReportStore->>TechReportStore : 添加报告到列表
TechReportStore->>ReportView : 报告提交成功
ReportView->>TechReportStore : 调用getReportList()
TechReportStore->>TechReportService : 调用getReportList API
TechReportService->>Backend : 获取报告列表
Backend-->>TechReportService : 返回报告记录
TechReportService-->>TechReportStore : 转换为TechReport数组
TechReportStore->>ReportView : 返回报告列表
```

**图示来源**
- [techReport.ts](file://src/stores/techReport.ts)
- [techReport.ts](file://src/services/techReport.ts)
- [TechReportNewView.vue](file://src/views/tech-report/TechReportNewView.vue)

**本节来源**
- [techReport.ts](file://src/stores/techReport.ts)
- [techReport.ts](file://src/services/techReport.ts)
- [TechReportNewView.vue](file://src/views/tech-report/TechReportNewView.vue)

## 模块化组织与职责划分

项目采用模块化的状态管理设计，每个store文件对应一个业务领域，实现了清晰的职责划分。

### State、Getters、Actions职责

Pinia store的三个核心组成部分具有明确的职责划分：

```mermaid
flowchart TD
A[State] --> |存储| B[响应式数据]
C[Getters] --> |计算| D[派生状态]
E[Actions] --> |处理| F[业务逻辑]
B --> |供Getters使用| C
C --> |供组件使用| G[组件]
F --> |修改| A
A --> |供组件使用| G
```

- **State**：存储组件的响应式数据，如`token`、`user`、`searchResults`等
- **Getters**：计算派生状态，如`isLoggedIn`、`hasResults`等，具有缓存特性
- **Actions**：处理业务逻辑，包括同步和异步操作，如`login`、`quickSearch`等

### 类型定义与服务分离

项目通过类型定义和服务分离实现了良好的类型安全和关注点分离。

```mermaid
graph LR
A[Store] --> B[Type Definitions]
A --> C[Service Layer]
C --> D[HTTP Requests]
B --> E[Interface Definitions]
style A fill:#FF9800,stroke:#F57C00
style B fill:#9C27B0,stroke:#7B1FA2
style C fill:#00BCD4,stroke:#00ACC1
style D fill:#4CAF50,stroke:#388E3C
```

**本节来源**
- [auth.ts](file://src/stores/auth.ts)
- [patentSearch.ts](file://src/stores/patentSearch.ts)
- [techReport.ts](file://src/stores/techReport.ts)
- [index.ts](file://src/types/index.ts)
- [auth.ts](file://src/services/auth.ts)
- [patentSearch.ts](file://src/services/patentSearch.ts)
- [techReport.ts](file://src/services/techReport.ts)

## 组件中使用Store

在Vue组件中使用Pinia store非常简单，通过`setup`语法糖可以方便地访问store实例。

### 使用示例

在组件中导入并使用store的典型模式：

```mermaid
flowchart TD
A[导入useStore] --> B[调用useStore]
B --> C[获取store实例]
C --> D[访问state]
C --> E[访问getters]
C --> F[调用actions]
D --> G[在模板中显示]
E --> G
F --> H[响应用户交互]
```

**本节来源**
- [LoginView.vue](file://src/views/auth/LoginView.vue)
- [SearchResultsView.vue](file://src/views/patent-search/SearchResultsView.vue)
- [TechReportNewView.vue](file://src/views/tech-report/TechReportNewView.vue)

## 状态持久化与错误处理

项目实现了完善的状态持久化和错误处理机制，确保用户体验的连续性和系统的健壮性。

### 状态持久化

通过`storage`工具类实现状态的本地持久化，确保页面刷新后用户状态不丢失。

```mermaid
flowchart TD
A[Store State] --> B[storage.set]
B --> C[localStorage]
C --> D[页面刷新]
D --> E[storage.get]
E --> F[Store初始化]
F --> A
```

**本节来源**
- [auth.ts](file://src/stores/auth.ts)
- [index.ts](file://src/utils/index.ts)

## 测试策略

项目为关键状态管理模块提供了单元测试，确保核心功能的正确性和稳定性。

### 测试覆盖

测试策略包括：
- Store初始化状态验证
- Actions的异步操作测试
- Getters的计算逻辑验证
- 错误处理路径测试

**本节来源**
- [auth.test.ts](file://tests/unit/stores/auth.test.ts)