# 故障排除

<cite>
**本文档引用的文件**
- [TOKEN_FIX.md](file://TOKEN_FIX.md)
- [FILE_DOWNLOAD_FIX.md](file://FILE_DOWNLOAD_FIX.md)
- [IMAGE_PREVIEW_FIX.md](file://IMAGE_PREVIEW_FIX.md)
- [CAPTCHA_FIX.md](file://CAPTCHA_FIX.md)
- [SSE_MESSAGE_PARSE_FIX.md](file://SSE_MESSAGE_PARSE_FIX.md)
- [SSE_NOTIFICATION_DISPLAY_FIX.md](file://SSE_NOTIFICATION_DISPLAY_FIX.md)
- [TOKEN_AUTO_REDIRECT.md](file://TOKEN_AUTO_REDIRECT.md)
- [SSE_DEBUG_GUIDE.md](file://SSE_DEBUG_GUIDE.md)
- [src/services/http.ts](file://src/services/http.ts)
- [src/services/notification.ts](file://src/services/notification.ts)
- [src/layouts/AppHeader.vue](file://src/layouts/AppHeader.vue)
- [src/stores/auth.ts](file://src/stores/auth.ts)
- [src/utils/index.ts](file://src/utils/index.ts)
- [src/views/auth/LoginView.vue](file://src/views/auth/LoginView.vue)
</cite>

## 目录
1. [Token相关问题](#token相关问题)
2. [文件下载异常](#文件下载异常)
3. [图片预览失败](#图片预览失败)
4. [验证码显示问题](#验证码显示问题)
5. [SSE消息解析错误](#sse消息解析错误)
6. [通知显示异常](#通知显示异常)
7. [诊断工具与日志分析](#诊断工具与日志分析)
8. [环境验证步骤](#环境验证步骤)

## Token相关问题

### Token双引号问题

**症状描述**
- 用户操作时，API请求返回401未授权错误
- 控制台显示"登录已过期，请重新登录"提示
- Authorization请求头中的token值包含双引号

**根本原因分析**
- `storage.set()`方法使用`JSON.stringify()`存储token，导致字符串token被转换为JSON格式
- HTTP拦截器直接使用`localStorage.getItem('token')`读取，获取到的是带双引号的字符串
- 后端无法识别带双引号的token格式

**修复步骤**
1. 在读取token时，先尝试`JSON.parse()`处理
2. 如果解析失败，则直接使用原始值
3. 修改`src/services/http.ts`中的请求拦截器逻辑

**预防措施**
- 统一存储读取方式：使用`storage.set()`存储时，必须使用`storage.get()`读取
- 推荐直接存储字符串：`localStorage.setItem('token', token)`
- 添加类型检查确保token为字符串类型

**Section sources**
- [TOKEN_FIX.md](file://TOKEN_FIX.md)
- [src/services/http.ts](file://src/services/http.ts#L20-L45)

### Token过期自动跳转

**症状描述**
- 用户长时间未操作后，再次操作时系统无响应
- 需要手动刷新页面并重新登录
- 缺乏明确的过期提示

**根本原因分析**
- 旧实现使用`window.location.href`进行跳转，导致整页刷新
- 没有防止重复提示机制，多个401请求会触发多次提示
- 未保留重定向路径，登录后无法返回原页面

**修复步骤**
1. 使用Vue Router的`router.push()`替代`window.location.href`
2. 添加`isTokenExpiredMessageShown`标志位防止重复提示
3. 保存当前路径，在登录后自动跳转回原页面
4. 清除所有认证信息：token、user、tokenExpireTime

**预防措施**
- 使用SPA内路由跳转，避免整页刷新
- 添加延迟跳转确保用户能看到提示消息
- 在非登录/注册页面才保留redirect参数，防止循环跳转

**Section sources**
- [TOKEN_AUTO_REDIRECT.md](file://TOKEN_AUTO_REDIRECT.md)
- [src/services/http.ts](file://src/services/http.ts#L150-L200)

## 文件下载异常

### 下载功能不可靠

**症状描述**
- 点击下载按钮后无反应
- 浏览器弹窗拦截器阻止新窗口打开
- 下载失败时没有明确的错误提示
- 无法自定义下载文件名

**根本原因分析**
- 原方案使用`window.open(fileUrl, '_blank')`方式下载
- 该方式依赖浏览器行为，容易被拦截
- 缺乏错误处理和降级机制
- 无法控制下载文件名

**修复步骤**
1. 采用`<a download>`方式实现直接下载
2. 创建隐藏的a标签并设置`download`属性
3. 添加双重保障机制：失败时自动降级到`window.open()`
4. 实现智能文件命名规则

**预防措施**
- 优先使用`<a download>`方式，提供更好的用户体验
- 确保文件服务器支持CORS和正确的响应头
- 验证文件URL是否存在，提供清晰的错误提示
- 避免特殊字符，使用下划线连接文件名

**Section sources**
- [FILE_DOWNLOAD_FIX.md](file://FILE_DOWNLOAD_FIX.md)
- [src/views/tech-report/TechReportHistoryView.vue](file://src/views/tech-report/TechReportHistoryView.vue)
- [src/views/defense-support/DefenseSimulationView.vue](file://src/views/defense-support/DefenseSimulationView.vue)

## 图片预览失败

### 图片点击放大无反应

**症状描述**
- 生产环境中点击图片无任何反应
- 开发环境正常但生产环境失效
- 图片预览功能完全无法使用

**根本原因分析**
- 在图片容器上添加了`@click.stop`事件修饰符
- 该修饰符阻止了点击事件向上冒泡
- Element Plus的`el-image`预览功能依赖点击事件
- 生产环境打包后事件处理更加严格

**修复步骤**
1. 移除图片容器上的`@click.stop`修饰符
2. 添加`:z-index="3000"`确保预览层在最上层
3. 保留`preview-teleported`属性
4. 确保蒙层设置`pointer-events: none`

**预防措施**
- 谨慎使用`@click.stop`，只在确实需要时使用
- 将图片预览功能封装成独立组件
- 记录组件使用方式和注意事项
- 提供示例代码和最佳实践

**Section sources**
- [IMAGE_PREVIEW_FIX.md](file://IMAGE_PREVIEW_FIX.md)
- [src/views/tech-report/TechReportHistoryView.vue](file://src/views/tech-report/TechReportHistoryView.vue#L43)
- [src/views/patent-search/QuickSearchView.vue](file://src/views/patent-search/QuickSearchView.vue#L57)

## 验证码显示问题

### 验证码图片无法显示

**症状描述**
- 注册页面验证码区域为空白
- 控制台出现图片加载错误
- 无法完成注册流程

**根本原因分析**
- 后端返回的img字段是纯Base64字符串
- 缺少`data:image/jpeg;base64,`前缀
- `<img>`标签无法直接显示无前缀的Base64字符串

**修复步骤**
1. 在`getCaptcha()`方法中添加前缀处理逻辑
2. 使用`startsWith('data:')`检查是否已包含前缀
3. 若无前缀则添加标准的Data URL格式前缀
4. 默认使用`image/jpeg`格式

**预防措施**
- 实现兼容性处理，支持已包含前缀的情况
- 根据响应头或其他字段判断实际图片格式
- 测试不同浏览器的兼容性
- 验证注册流程的完整性

**Section sources**
- [CAPTCHA_FIX.md](file://CAPTCHA_FIX.md)
- [src/services/auth.ts](file://src/services/auth.ts#L10-L30)

## SSE消息解析错误

### 消息解析失败

**症状描述**
- SSE连接成功但消息无法显示
- 控制台出现JSON解析错误
- 纯文本消息被丢弃

**根本原因分析**
- 前端代码强制使用`JSON.parse()`解析消息
- 后端发送的SSE消息可能是纯文本格式
- 异常被捕获后消息被丢弃，没有降级处理

**修复步骤**
1. 增强`parseSSEMessage`方法的容错能力
2. 优先尝试JSON解析，失败时作为纯文本处理
3. 为纯文本消息创建默认通知对象
4. 支持多种字段名称：message、content、msg

**预防措施**
- 实现双重处理机制：JSON格式和纯文本
- 添加详细的日志输出便于调试
- 每个消息处理器都用try-catch包裹
- 推荐后端使用标准JSON格式发送消息

**Section sources**
- [SSE_MESSAGE_PARSE_FIX.md](file://SSE_MESSAGE_PARSE_FIX.md)
- [src/services/notification.ts](file://src/services/notification.ts#L150-L200)

## 通知显示异常

### 通知不显示在界面

**症状描述**
- SSE连接成功且消息已解析
- 控制台有日志但界面无提示
- 通知列表为空或未更新

**根本原因分析**
- `ElMessage`的`message`参数可能为空字符串
- `type`类型可能不是有效值（success、warning、info、error）
- 没有错误处理，一旦失败整个处理器停止
- Vue响应式数据更新异常

**修复步骤**
1. 添加消息内容保护：`message || title || '新消息'`
2. 验证type类型是否为有效值，否则默认为'info'
3. 为每个操作添加try-catch错误隔离
4. 实现降级处理：简单提示作为备选

**预防措施**
- 确保消息内容不为空，提供默认值
- 严格验证type类型，防止无效值
- 分离通知列表更新和消息提示逻辑
- 添加详细日志记录处理过程

**Section sources**
- [SSE_NOTIFICATION_DISPLAY_FIX.md](file://SSE_NOTIFICATION_DISPLAY_FIX.md)
- [src/layouts/AppHeader.vue](file://src/layouts/AppHeader.vue#L300-L400)

## 诊断工具与日志分析

### SSE调试指南

**调试日志流程**
登录成功后，控制台会输出完整的SSE连接调试日志，包括：
- 登录流程日志
- 获取用户详细信息
- SSE连接建立流程
- 连接成功日志
- 消息接收日志
- 连接错误日志
- 登出日志

**调试技巧**
- 检查连接状态：`notificationService.isConnected()`
- 查看当前用户信息：`JSON.parse(localStorage.getItem('user'))`
- 手动触发连接：`notificationService.connect(user.userId)`
- 查看网络请求中的EventStream

**常见问题排查**
- **连接建立失败**：检查userId和token是否存在，查看网络请求状态码
- **能连接但收不到消息**：确认消息处理器已注册，检查后端是否发送数据
- **连接频繁断开重连**：检查网络稳定性，查看后端日志
- **登录后没有建立连接**：确认`getUserInfo`执行，检查用户信息包含userId

**Section sources**
- [SSE_DEBUG_GUIDE.md](file://SSE_DEBUG_GUIDE.md)
- [src/services/notification.ts](file://src/services/notification.ts)
- [src/layouts/AppHeader.vue](file://src/layouts/AppHeader.vue)

## 环境验证步骤

### 基础连接测试
1. 登录系统
2. 查看控制台日志，确认连接成功
3. 查看Network标签，确认SSE连接保持打开状态

### 消息接收测试
1. 后端手动推送一条测试消息
2. 查看控制台日志，确认收到消息
3. 查看页面右上角通知图标，确认未读数量增加
4. 点击通知图标，查看消息列表

### 重连测试
1. 断开网络连接
2. 查看控制台，确认开始重连
3. 恢复网络连接
4. 确认重连成功

### 登出测试
1. 点击登出按钮
2. 查看控制台，确认SSE连接已断开
3. 确认通知列表已清空

**Section sources**
- [SSE_DEBUG_GUIDE.md](file://SSE_DEBUG_GUIDE.md)
- [src/stores/auth.ts](file://src/stores/auth.ts#L200-L250)