# 登录功能

<cite>
**本文档引用的文件**
- [LoginView.vue](file://src/views/auth/LoginView.vue)
- [auth.ts](file://src/stores/auth.ts)
- [auth.ts](file://src/services/auth.ts)
- [LOGIN_CAPTCHA_INTEGRATION.md](file://LOGIN_CAPTCHA_INTEGRATION.md)
</cite>

## 目录
1. [介绍](#介绍)
2. [表单结构与字段验证](#表单结构与字段验证)
3. [验证码机制](#验证码机制)
4. [登录提交流程](#登录提交流程)
5. [安全集成与前后端交互](#安全集成与前后端交互)
6. [常见问题排查](#常见问题排查)

## 介绍
本系统登录功能通过集成验证码机制，提升账户安全性。`LoginView` 组件作为用户身份验证的入口，实现了完整的表单输入、验证、提交及状态反馈流程。结合 `authStore` 和 `authService`，实现了与后端的安全通信、JWT 令牌管理以及用户状态持久化。整个流程遵循安全最佳实践，防止暴力破解，并提供良好的用户体验。

## 表单结构与字段验证
登录表单由用户名、密码和验证码三个核心字段构成，采用 Element Plus 的 `el-form` 组件实现数据绑定与验证。

**表单字段说明：**
- **用户名**：支持输入用户名或手机号，输入框带有用户图标前缀，支持回车提交。
- **密码**：密码输入框带有锁形图标，支持显示/隐藏密码功能。
- **验证码**：包含一个输入框和一个验证码图片展示区，两者水平排列。

**字段验证规则如下：**

| 字段 | 验证规则 | 触发时机 | 错误提示 |
|------|--------|---------|--------|
| 用户名 | 必填，长度不少于3位 | 失去焦点时 | "请输入用户名或邮箱"，"用户名长度不能少于3位" |
| 密码 | 必填，长度不少于6位 | 失去焦点时 | "请输入密码"，"密码长度不能少于6位" |
| 验证码 | 必填，通过自定义验证器校验 | 失去焦点时 | "请输入验证码" |

表单使用 `ref` 进行引用，以便在提交时调用 `validate()` 方法进行整体校验。只有当所有字段都通过验证时，才会执行登录逻辑。

**Section sources**
- [LoginView.vue](file://src/views/auth/LoginView.vue#L13-L50)

## 验证码机制
验证码是登录流程中的关键安全组件，用于防止自动化脚本的暴力破解攻击。

### 验证码图片展示与刷新逻辑
- **初始加载**：在 `LoginView` 组件的 `onMounted` 生命周期钩子中，自动调用 `getCaptcha()` 方法获取初始验证码。
- **图片展示**：验证码图片通过 `<img>` 标签展示，其 `src` 属性绑定到 `captchaImg` 响应式变量。该变量存储的是带有 `data:image/jpeg;base64,` 前缀的 Base64 编码字符串，可直接在浏览器中渲染。
- **手动刷新**：用户可以点击验证码图片区域触发 `refreshCaptcha()` 方法，该方法会重新调用 `getCaptcha()` 以获取新的验证码图片和 UUID。
- **自动刷新**：当登录失败时，系统会自动调用 `refreshCaptcha()` 并清空验证码输入框，确保用户使用新的验证码进行下一次尝试。

```mermaid
flowchart TD
A[页面加载完成] --> B[调用 getCaptcha()]
B --> C{获取成功?}
C --> |是| D[更新 captchaImg 和 captchaUuid]
C --> |否| E[显示错误提示]
F[用户点击验证码图片] --> B
G[登录失败] --> B
H[验证码输入框回车] --> I[触发 handleLogin]
```

**Diagram sources**
- [LoginView.vue](file://src/views/auth/LoginView.vue#L199-L243)

## 登录提交流程
从用户点击登录按钮到成功跳转，整个流程涉及多个组件的协同工作。

### 1. 用户交互与前端处理
当用户点击“登录”按钮或在验证码输入框按回车键时，会触发 `handleLogin` 方法。

```mermaid
sequenceDiagram
participant 用户
participant LoginView
participant authStore
participant authService
participant 后端API
用户->>LoginView : 点击登录按钮
LoginView->>LoginView : 调用 handleLogin()
LoginView->>LoginView : 执行表单验证
alt 验证失败
LoginView-->>用户 : 显示错误提示
stop
end
LoginView->>authStore : 调用 login() action
authStore->>authService : 调用 login() 方法
authService->>后端API : POST /login (含凭证)
后端API-->>authService : 返回 token 和用户信息
authService-->>authStore : 返回登录响应
authStore->>authStore : 保存 token 到 localStorage
authStore->>authStore : 保存用户信息到 localStorage
authStore->>authStore : 建立 SSE 连接
authStore-->>LoginView : 登录成功
LoginView->>LoginView : 显示成功消息
LoginView->>LoginView : 获取 redirect 参数
LoginView->>路由 : 跳转至目标页面
```

**Diagram sources**
- [LoginView.vue](file://src/views/auth/LoginView.vue#L203-L256)
- [auth.ts](file://src/stores/auth.ts#L25-L70)
- [auth.ts](file://src/services/auth.ts#L14-L58)

### 2. 核心步骤详解
1.  **表单验证**：`handleLogin` 方法首先通过 `loginFormRef.value.validate()` 对整个表单进行校验。
2.  **调用登录**：验证通过后，调用 `authStore.login()` 方法，并传入包含用户名、密码、验证码、UUID 和“记住我”选项的凭证对象。
3.  **状态管理**：`authStore` 的 `login` action 负责协调登录过程。它调用 `authService.login()` 与后端通信。
4.  **JWT 处理**：`authService` 接收到后端返回的 JWT token 后，将其封装在 `LoginResponse` 对象中返回给 `authStore`。
5.  **持久化存储**：`authStore` 将 token 和用户信息通过 `storage.set()` 方法存储到 `localStorage` 中，实现持久化。如果用户勾选了“记住我”，还会设置一个过期时间。
6.  **建立连接**：登录成功后，`authStore` 会立即调用 `getUserInfo()` 获取更详细的用户信息，并使用 `userId` 建立 Server-Sent Events (SSE) 连接，用于接收实时通知。
7.  **路由跳转**：`handleLogin` 捕获到登录成功后，会检查路由的 `redirect` 查询参数。如果存在，则跳转到该路径；否则，默认跳转到 `/app/dashboard`。

**Section sources**
- [LoginView.vue](file://src/views/auth/LoginView.vue#L203-L256)
- [auth.ts](file://src/stores/auth.ts#L25-L70)
- [auth.ts](file://src/services/auth.ts#L14-L58)

## 安全集成与前后端交互
根据 `LOGIN_CAPTCHA_INTEGRATION.md` 文档，验证码在登录流程中扮演着至关重要的安全角色。

### 安全作用
- **防暴力破解**：每次登录请求都必须附带一个一次性验证码，极大增加了自动化脚本尝试的难度。
- **一次性验证**：验证码在使用一次后即失效（无论成功或失败），防止重放攻击。
- **时效性控制**：验证码由后端生成并设置有效期，过期后无法使用。
- **唯一标识**：每个验证码都关联一个唯一的 `uuid`，前端在获取和提交时必须使用同一个 `uuid`，确保请求的关联性。

### 前后端集成方式
1.  **获取验证码**：
    - **前端**：调用 `authStore.getCaptcha()`。
    - **后端**：请求 `GET /api/captchaImage` 接口。
    - **数据处理**：后端返回纯 Base64 字符串，前端自动添加 `data:image/jpeg;base64,` 前缀以供 `<img>` 标签使用。
2.  **提交登录**：
    - **前端**：将 `username`、`password`、`code`（用户输入的验证码）和 `uuid`（从上一步获取）一并提交。
    - **后端**：请求 `POST /api/login` 接口。
    - **验证**：后端验证 `uuid` 对应的验证码是否与 `code` 匹配且未过期。
    - **响应**：验证通过后，返回 JWT `token`。

此集成方式确保了登录过程的安全性，并与注册功能的验证码实现保持一致，保证了代码的可维护性和用户体验的统一性。

**Section sources**
- [LOGIN_CAPTCHA_INTEGRATION.md](file://LOGIN_CAPTCHA_INTEGRATION.md#L1-L217)

## 常见问题排查
### 验证码错误
- **现象**：输入正确的验证码后仍提示“验证码错误”。
- **排查步骤**：
  1.  检查网络是否正常，确认 `GET /api/captchaImage` 请求成功。
  2.  查看浏览器开发者工具的 Network 面板，确认返回的 `uuid` 和 `img` 数据是否正确。
  3.  确认在提交登录时，使用的 `uuid` 是否与获取验证码时的 `uuid` 完全一致。
  4.  检查验证码是否已过期（通常为几分钟），尝试刷新后重新输入。

### 网络连接失败
- **现象**：点击登录后长时间无响应，或提示“网络错误，请检查网络连接”。
- **排查步骤**：
  1.  检查本地网络连接是否正常。
  2.  确认后端服务地址 `VITE_API_BASE_URL` 配置正确。
  3.  打开浏览器开发者工具的 Network 面板，查看 `POST /api/login` 请求的状态。
  4.  如果请求状态为 `Failed` 或 `ERR_CONNECTION_REFUSED`，说明前端无法连接到后端服务器，请检查后端服务是否已启动。
  5.  如果请求状态为 `CORS` 错误，说明存在跨域问题，需要后端配置正确的 CORS 策略。

**Section sources**
- [auth.ts](file://src/services/auth.ts#L30-L58)
- [http.ts](file://src/services/http.ts#L130-L180)